name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        node-version: 10.x
    - run: yarn
    - run: yarn test
    - name: Code Coverage
      if: github.event_name == 'push'
      run: yarn test --coverage --coverageReporters=text-lcov | npx coveralls
      env:
        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
    - name: Lighthouse
      if: github.event_name == 'pull_request'
      run: |
        sed -i.bak "s/{{ NOW_URL }}/$(npx now --token $ZEIT_TOKEN ls wyze.github.io | sed -n 2p | tr -s ' ' | cut -d ' ' -f 3)/g" codechecks.yml
        yarn add --dev @codechecks/client @codechecks/lighthouse-keeper
        npx codechecks
      env:
        ZEIT_TOKEN: ${{ secrets.ZEIT_TOKEN }}
        CC_SECRET: ${{ secrets.CC_SECRET }}
